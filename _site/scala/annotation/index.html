<!DOCTYPE html>
<html id="J-html" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="generator" content="Jekyll" />
    <title>Scala基础之注解(annotation)</title>
    <meta name="description" content="本文罗列了Scala中常见的注解以及基本的应用" />
    <meta name="keywords" content="注解，序列化，瞬时的状态" /><!-- For SEO-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" type="text/css" media="all" href="/static/css/style.css" />
    <!-- syntax highlighting CSS  need pygments support-->
    <link rel="stylesheet" href="/static/css/syntax.css" type="text/css" />
    <!-- use to display line number-->
    <!--<link rel="stylesheet" href="/static/css/line.css" type="text/css" />-->
    <!--[if lt IE 9]>
    <script src="/static/js/html5.js" type="text/javascript"></script>
    <![endif]-->
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="home blog lotus index">
    <nav class="lotus-nav">
        <ul>
             
                 
                 
                 
                
            <li class="home ">
                <a href="/" rel="bookmark" title="首页">
                    <i class="icon-home"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="/archives/" rel="bookmark" title="文章归档">
                    <i class="icon-reorder"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="https://github.com/jacoffee/jacoffee.github.io" rel="bookmark" title="博客源代码">
                    <i class="icon-github"></i>
                </a>
                
            </li>
            
        </ul>
    </nav>

    <p class="lotus-breadcrub">
    <a href="/" rel="nofollow" rel="nofollow" title="首页">Home</a>
    <span> &gt; </span>
    <a href="/archives/" rel="nofollow" >Archives</a>
    <span> &gt; </span>
    Scala基础之注解(annotation)
</p>

<h1 class="lotus-pagetit">Scala基础之注解(annotation)</h1>

<p class="lotus-meta">Published on <time class="date" pubdate="2015-04-11">2015-04-11</time></p>

<article  itemscope itemtype="http://schema.org/Article" class="lotus-post">
<p>在学习Scala的过程中，总会碰到一些注解:</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="c1">// Predef.scala
</span><span class="nd">@inline</span> <span class="k">def</span> <span class="n">implicitly</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="k">implicit</span> <span class="n">e</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span> <span class="k">=</span> <span class="n">e</span>

<span class="nd">@deprecated</span><span class="o">(</span><span class="s">"Use `sys.error(message)` instead"</span><span class="o">,</span> <span class="s">"2.9.0"</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">error</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Nothing</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>

<span class="c1">// Spark RDD.scala
</span><span class="k">abstract</span> <span class="k">class</span> <span class="nc">RDD</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">ClassTag</span><span class="o">](</span>
    <span class="nd">@transient</span> <span class="k">private</span> <span class="k">var</span> <span class="n">sc</span><span class="k">:</span> <span class="kt">SparkContext</span><span class="o">,</span>
    <span class="o">....)</span>
</code></pre></div>
<p>当然上面只是列举了一部分，本文只介绍比较常见的注解以及定义的方法。</p>

<h1>解决</h1>

<p><1> 注解的作用域</p>

<p>一般来说，注解可以作用于vals, vars, defs, classes, objects, traits, and types甚至是表达式的后面。</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">scala.reflect.runtime.</span><span class="o">{</span> <span class="n">universe</span> <span class="k">=&gt;</span> <span class="n">ju</span> <span class="o">}</span>

<span class="k">def</span> <span class="n">meth</span><span class="o">[</span><span class="kt">A:</span> <span class="kt">ju.TypeTag</span><span class="o">](</span><span class="n">xs</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">=</span> <span class="n">xs</span> <span class="k">match</span> <span class="o">{</span>
 <span class="k">case</span> <span class="n">strList</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span> <span class="kt">@</span> <span class="kt">unchecked</span><span class="o">]</span> 
    <span class="k">if</span> <span class="n">ju</span><span class="o">.</span><span class="n">typeTag</span><span class="o">[</span><span class="kt">A</span><span class="o">].</span><span class="n">tpe</span> <span class="o">=:=</span> <span class="n">ju</span><span class="o">.</span><span class="n">typeOf</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="s">"list of Strings"</span>
 <span class="k">case</span> <span class="n">barList</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Bar</span> <span class="kt">@</span> <span class="kt">unchecked</span><span class="o">]</span> 
    <span class="k">if</span> <span class="n">ju</span><span class="o">.</span><span class="n">typeTag</span><span class="o">[</span><span class="kt">A</span><span class="o">].</span><span class="n">tpe</span> <span class="o">=:=</span> <span class="n">ju</span><span class="o">.</span><span class="n">typeOf</span><span class="o">[</span><span class="kt">Bar</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="s">"list of Bar"</span>
<span class="o">}</span>
</code></pre></div>
<p>我们知道List[T]在运行时会被类型擦除，相当于变成List。@unchecked 告诉compiler不要去检查这个，否则就会报下面的warning。</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">non</span><span class="o">-</span><span class="n">variable</span> <span class="k">type</span> <span class="kt">argument</span> <span class="kt">String</span> <span class="kt">in</span> <span class="k">type</span> <span class="kt">pattern</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">is</span> <span class="n">unchecked</span> 
<span class="n">since</span> <span class="n">it</span> <span class="n">is</span> <span class="n">eliminated</span> <span class="n">by</span> <span class="n">erasure</span>
</code></pre></div>
<p>另外, 注解实际上也是普通的类只不过Compiler对其进行特殊的支持，所以我们才能那样书写。比如说，我们常见的序列号的注解。</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">SerialVersionUID</span><span class="o">(</span><span class="n">uid</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span> <span class="k">extends</span> <span class="n">scala</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="nc">StaticAnnotation</span>

<span class="nd">@SerialVersionUID</span><span class="o">(</span><span class="mi">13567156</span><span class="o">)</span>
<span class="k">class</span> <span class="nc">B</span> <span class="o">{}</span>

<span class="nd">@deprecated</span><span class="o">(</span><span class="s">"use newShinyMethod() instead"</span><span class="o">,</span> <span class="s">"since 2.3"</span><span class="o">)</span>
<span class="k">def</span> <span class="n">bigMistake</span><span class="o">()</span> <span class="k">=</span>  <span class="c1">//...
</span><span class="n">bigMistake</span>

<span class="n">scalac</span> <span class="o">-</span><span class="n">deprecation</span> <span class="nc">Deprecation2</span><span class="o">.</span><span class="n">scala</span>

<span class="n">warning</span><span class="k">:</span> <span class="kt">method</span> <span class="kt">bigMistake</span> <span class="kt">in</span> <span class="kt">class</span> <span class="kt">B</span> <span class="kt">is</span> <span class="kt">deprecated:</span> <span class="kt">use</span> <span class="kt">newShinyMethod</span><span class="o">()</span> <span class="kt">instead</span>
  <span class="n">println</span><span class="o">(</span><span class="n">bigMistake</span><span class="o">)</span>
          <span class="o">^</span>
<span class="n">one</span> <span class="n">warning</span> <span class="n">found</span>
</code></pre></div>
<p><2> 几种常见的注解</p>

<p>最常见应该是上面已经提到的Deprecated，另外几种常见的如下:</p>

<p>(1) @volatile</p>

<p>实际上这个注解或是关键字，大多用于被并发访问的共享变量。虽然Scala对于并发的处理就是尽量减少共享变量，当我们不得不这样的时候就可以使用volatile， 它告诉JVM，当某个值在某个地方被更新的时候，要确保下次另一个线程访问的时候是最新的值(当然实际情况可能没有这么简单)。
volatile涉及的并发知识点还是很多的，但这并不是本文的重点。</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="nd">@volatile</span> <span class="k">var</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">set</span><span class="o">(</span><span class="n">changedName</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">name</span> <span class="k">=</span> <span class="n">changedName</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>(2) @tailrec </p>

<p>这个注解是与尾递归优化有关的，在Scala中如果写了一个需要递归的方法，这样我们就能够在方法的签名处添加@tailrec告诉Scala Compiler进行尾递归优化(有兴趣可以去Programming In Scala第8章看看)。</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="c1">// 阶乘
</span><span class="k">def</span> <span class="n">factorial</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nd">@tailrec</span> <span class="k">def</span> <span class="n">go</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">acc</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="o">)</span> <span class="n">acc</span>
        <span class="k">else</span> <span class="n">go</span><span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">acc</span> <span class="o">*</span> <span class="n">n</span><span class="o">)</span> 
        <span class="c1">// 尾递归，顾名思义方法的调用也必须出现在返回值的位置
</span>    <span class="o">}</span>
    <span class="n">go</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div>
<p>(3) @Unchecked</p>

<p>上面已经提到了，一般是在模式匹配的时候用到的，告诉Compiler有些地方不用&quot;检查&quot;了。如前所述，List[String @ unchecked]。</p>

<p>(4) @transient</p>

<p>这个注解一般用于序列化的时候标识某个字段不想要被序列化，这样即使它所在的对象被序列化，它也不会。</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">java.io.</span><span class="o">{</span> <span class="nc">FileOutputStream</span><span class="o">,</span> <span class="nc">FileInputStream</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">java.io.</span><span class="o">{</span> <span class="nc">ObjectOutputStream</span><span class="o">,</span> <span class="nc">ObjectInputStream</span> <span class="o">}</span>

<span class="k">class</span> <span class="nc">Hippie</span><span class="o">(</span><span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="nd">@transient</span> <span class="k">val</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Serializable</span>

<span class="k">object</span> <span class="nc">Serialization</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">fos</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="s">"hippie.txt"</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">oos</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="n">fos</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">p1</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Hippie</span><span class="o">(</span><span class="s">"zml"</span><span class="o">,</span> <span class="mi">34</span><span class="o">)</span>
    <span class="n">oos</span><span class="o">.</span><span class="n">writeObject</span><span class="o">(</span><span class="n">p1</span><span class="o">)</span>
    <span class="n">oos</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Deserialization</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">fis</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"hippie.txt"</span><span class="o">)</span> 
    <span class="k">val</span> <span class="n">ois</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="n">fis</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">hippy</span> <span class="k">=</span> <span class="n">ois</span><span class="o">.</span><span class="n">readObject</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">Hippie</span><span class="o">]</span>
    <span class="n">println</span><span class="o">(</span><span class="n">hippy</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
    <span class="n">println</span><span class="o">(</span><span class="n">hippy</span><span class="o">.</span><span class="n">age</span><span class="o">)</span>
    <span class="n">ois</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
<span class="o">}</span>

<span class="n">运行之后的结果</span>
<span class="n">zml</span>
<span class="mi">0</span>
</code></pre></div>
<p>由于age被标记为@transient，在反序列化的时候，就获取不到原始值了所以被赋值为默认值。</p>

<p>(5) @inline</p>

<p>这个注解，在Scala.Predef中见到过一次。</p>

<blockquote>
<p>An annotation on methods that requests that the compiler should
try especially hard to inline the annotated method.</p>
</blockquote>

<p>文档中的解释跟没有一样，在StackOverflow上找到几个问题，其中参考<5>中的有一段解释，个人觉得比较能说明作用。</p>

<blockquote>
<p>Instead of a function call resulting in parameters being placed on the stack and an invoke operation occurring, 
the definition of the function is copied at compile time to where the invocation was made, 
saving the invocation overhead at runtime.</p>
</blockquote>

<p>大致的意思就是@inline能够避免方法的参数被放到栈上，以及&quot;显示的调用&quot;，因为编译器在编译的时候会将整个方法copy到它被调用的地方。</p>

<h1>参考</h1>

<p><1> <a href="https://www.artima.com/pins1ed/annotations.html">annotation</a></p>

<p><2> <a href="https://twitter.github.io/scala_school/zh_cn/concurrency.html#danger">volatile</a></p>

<p><3> <a href="http://stackoverflow.com/questions/1031167/should-my-scala-actors-properties-be-marked-volatile">should-my-scala-actors-properties-be-marked-volatile</a></p>

<p><4> <a href="https://twitter.github.io/scala_school/zh_cn/concurrency.html#danger">concurrency</a></p>

<p><5> <a href="http://stackoverflow.com/questions/4593710/when-should-i-and-should-i-not-use-scalas-inline-annotation">when-should-i-and-should-i-not-use-scalas-inline-annotation</a></p>

<p><6> <a href="http://stackoverflow.com/questions/2709095/does-the-inline-annotation-in-scala-really-help-performance">does-the-inline-annotation-in-scala-really-help-performance</a></p>

</article>


<p class="lotus-anno">声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="nofollow" target="_blank" title="自由转载-非商用-非衍生-保持署名">BY-NC-SA</a> 授权。转载请注明转自: 
<a href="/scala/annotation/" rel="nofollow">Allen</a></p>

<section class="lotus-nextpage fn-clear">
    
    <div class="lotus-nextpage-left"><a class="prev" href="/scala/quote/" rel="prev">&laquo;&nbsp;Scala基础之三引号(""")</a></div>
    
    
    <div class="lotus-nextpage-right"><a class="next" href="/linux/kill-processes/" rel="next">Linux基础之杀死进程(kill processes)&nbsp;&raquo;</a></div>
    
</section>


<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="226d7bec35395bb71452e8b95765c635" data-title="Scala基础之注解(annotation)" data-url="/scala/annotation/"></div>
<!-- 多说评论框 end -->



    <footer class="lotus-footer">
        <p>©2016 allen with website template from <a href="https://github.com/pizn/iLotus" target="_blank">iLotus</a> </p>
    </footer>
    <script src="/static/js/jquery.js" type="text/javascript"></script>
    <script src="/static/js/jquery.scrollTo.js" type="text/javascript"></script>
    <script src="/static/js/iLotus.js" type="text/javascript"></script>
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
        var duoshuoQuery = {
            short_name: "roadtopro"
        };
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';
            ds.async = true;
            ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共JS代码 end -->
</body>

</html>