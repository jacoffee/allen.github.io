<!DOCTYPE html>
<html id="J-html" class="">
<head>
    <meta charset="UTF-8" />
    <title>
         
            Scala基础之try...catch...finally 
        
    </title>
    <meta name="generator" content="Jekyll" />
    <meta name="description" content="一般异常处理的try...catch..finally总是会在finally中进行一些收尾的处理，本文研究了如果在finally中出现return语句以及异常会得到什么结果" />
    <meta name="keywords" content="异常处理,Return语句,流程控制" /><!-- For SEO-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" media="all" href="/static/css/style.css" />
    <!-- syntax highlighting CSS  need pygments support-->
    <link rel="stylesheet" href="/static/css/syntax.css" type="text/css" />
    <!-- use to display line number-->
    <!--<link rel="stylesheet" href="/static/css/line.css" type="text/css" />-->
    <!--[if lt IE 9]>
    <script src="/static/js/html5.js" type="text/javascript"></script>
    <![endif]-->
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="home blog lotus index">
    <nav class="lotus-nav">
        <ul>
             
                 
                 
                 
                 
                     
                
            <li class="home ">
                <a href="/" rel="bookmark" title="首页">
                    <i class="icon-home"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="/archives/" rel="bookmark" title="文章归档">
                    <i class="icon-reorder"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="https://github.com/jacoffee/jacoffee.github.io" rel="bookmark" title="博客源代码">
                    <i class="icon-github"></i>
                </a>
                
            </li>
            
        </ul>
    </nav>

    <p class="lotus-breadcrub">
    <a href="/" rel="nofollow" rel="nofollow" title="首页">Home</a>
    <span> &gt; </span>
    <a href="/archives/" rel="nofollow" >Archives</a>
    <span> &gt; </span>
    Scala基础之try...catch...finally
</p>

<h1 class="lotus-pagetit">Scala基础之try...catch...finally</h1>

<p class="lotus-meta">Published on <time class="date" pubdate="2015-02-04">2015-02-04</time></p>

<article  itemscope itemtype="http://schema.org/Article" class="lotus-post">
<p>今天，一同事在写一个异常捕获的时候，突然抛出以下代码，让我们研究返回值。</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">getResult</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="k">try</span> <span class="o">{</span>
    <span class="n">println</span><span class="o">(</span><span class="s">&quot;try执行了吗？&quot;</span><span class="err">）</span>
    <span class="k">return</span> <span class="mi">1</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">println</span><span class="o">(</span><span class="s">&quot;finally执行了吗？&quot;</span><span class="err">）</span>
    <span class="k">return</span> <span class="mi">3</span>
<span class="o">}</span>
</code></pre></div>
<p>首先上面那种写法就很奇怪，因为不管是在Scala还是Java中finally一般都是没有返回值(确切的说返回值是Unit)的。</p>

<h1>问题</h1>

<p>如果显示声明了return, 那么返回值应该是多少了。答案是此时返回值应该是<b style="color:red">finally中return的值</b>。
如果try中有异常而finally中没有异常且显示的声明了return，此时整个流程怎么走？
如果finally有异常，整个流程又怎么走？</p>

<h1>解决</h1>

<p>首先为什么上面的表达式返回的是<b style="color:red">3</b>，都说源码面前，了无秘密。通过<a href="http://jd.benow.ca/">Java Decompiler</a>将上面的Scala代码对应的class文件反解，就可以看到如下代码:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">int</span> <span class="nf">getResult</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span> <span class="n">Predef</span><span class="o">..</span><span class="na">MODULE$</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;try 执行了吗？ &quot;</span><span class="o">);</span>

      <span class="k">return</span> <span class="mi">3</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">finally</span>
    <span class="o">{</span>
      <span class="n">Predef</span><span class="o">..</span><span class="na">MODULE$</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot; finally 执行了吗&quot;</span><span class="o">);</span>
    <span class="o">}</span><span class="k">return</span> <span class="mi">3</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div>
<p>显然，finally中的代码已经改变原来的方法的执行流程，可以简单的理解为在Scala中</p>

<p><code>try { b } catch e1 finally e2</code></p>

<p><b style="color:red">b的类型是try表达式的期望类型, e1实际上是一个偏函数: scala.PartialFunction[scala.Throwable, pt], pt &lt;: b, 而e2的类型则是Unit</b>。
所以此时的控制流程又回到了try表达式中，因为此时<b style="color:red">只有try{}才可以返回满足方法签名类型的返回值</b>，也就是Int。
同时会将finally中的&#39;返回值&#39;作为最终的值返回。</p>

<p>下面针对不同情况下，try...catch...finally的处理进行解释:</p>

<p>首先明确的一点是finally无论如何都会执行，no matter what happens beforehand in the try block, always run this code.</p>

<p><1> 计算b的过程中没有异常</p>

<p>如果在计算表达式e的过程中又抛出异常，那么整个表达式会中止，并且抛出异常(e表达式中包含的异常)</p>

<p>如果在计算表达式的e的过程中没有抛出异常，那么b就是整个表达式的返回值</p>

<p><2> 计算b的过程中有异常(e中的表达式仍然会被计算)</p>

<p>如果e的计算过程也抛出异常，那么表达式会中止并且e过程中的异常被抛出</p>

<p>如果e的计算过程中没有抛出异常，那么原来b中的异常会在e计算完成之后再次抛出(关于这一点比较恐怖的是&lt;b style=&quot;color:</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala">  <span class="k">def</span> <span class="n">getResult</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="k">try</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">RuntimeException</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="k">return</span> <span class="mi">3</span>
  <span class="o">}</span>
</code></pre></div>
<p>上面这段代码还是会返回3。</p>

<p>最后贴一段<a href="http://docs.oracle.com/javase/specs/jls/se5.0/html/statements.html#14.17">JLS 14.17 The return Statement</a></p>

<blockquote>
<p>The preceding descriptions say &quot;attempts to transfer control&quot; rather than just &quot;transfers control&quot; because if there are any try statements (§14.20) within the method or 
constructor whose try blocks or catch clauses contain the return statement, then any finally clauses of those try statements will be executed, in order, innermost to 
outermost, before control is transferred to the invoker of the method or constructor. Abrupt completion of a finally clause can disrupt the transfer of control initiated by a 
return statement.</p>
</blockquote>

<p>简单的解释就是：如果在方法或构造器中包含return，那么try表达式中的finally中的语句会依次执行然后将流程返回给该方法或者是构造器的调用者。如果在finally的执行中，出现任何意外情况，那么流程的返回过程就会出现意外。</p>

<h1>结语</h1>

<p>我们最开始学习Java时候，各种教材都会讲到在定义Java变量名时我们尽量不要采用生僻的命名，这条规则同样适用于这里。</p>

<p>关于这个问题在<a href="http://stackoverflow.com/questions/65035/does-finally-always-execute-in-java">Stackoverlflow</a>有很多讨论涉及知识点也很多。总之一句话，我们尽量不要使用各种语法比较妖孽的地方，就比如说finally本来就不该出现return，它通常会用于处理异常抛出之后的收尾工作，比如说关闭流等。</p>

</article>


<p class="lotus-anno">声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="nofollow" target="_blank" title="自由转载-非商用-非衍生-保持署名">BY-NC-SA</a> 授权。转载请注明转自: 
<a href="/scala/try-catch/" rel="nofollow">Allen</a></p>

<section class="lotus-nextpage fn-clear">
    
    <div class="lotus-nextpage-left"><a class="prev" href="/build/blog-setup/" rel="prev">&laquo;&nbsp;使用Github Pages + Jekyll搭建个人Blog</a></div>
    
    
    <div class="lotus-nextpage-right"><a class="next" href="/scala/static-forwarder/" rel="next">Scala基础之静态代理(static-forwarder)&nbsp;&raquo;</a></div>
    
</section>


<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="9fc1d12984edc4fbd228195de9084ada" data-title="Scala基础之try...catch...finally" data-url="/scala/try-catch/"></div>
<!-- 多说评论框 end -->



    <footer class="lotus-footer">
        <p>Copyright © 2010–2015 <a href="https://github.com/pizn/iLotus" target="_blank">iLotus</a> All rights reserved.</p>
    </footer>
    <script src="/static/js/jquery.js" type="text/javascript"></script>
    <script src="/static/js/jquery.scrollTo.js" type="text/javascript"></script>
    <script src="/static/js/iLotus.js" type="text/javascript"></script>
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
        var duoshuoQuery = {
            short_name: "roadtopro"
        };
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';
            ds.async = true;
            ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共JS代码 end -->
</body>

</html>