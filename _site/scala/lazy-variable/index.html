<!DOCTYPE html>
<html id="J-html" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="generator" content="Jekyll" />
    <title>Scala基础之懒加载变量</title>
    <meta name="description" content="本文研究了Scala中懒加载变量背后的实现" />
    <meta name="keywords" content="延迟加载，双重检验锁，语法糖" /><!-- For SEO-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" type="text/css" media="all" href="/static/css/style.css" />
    <!-- syntax highlighting CSS  need pygments support-->
    <link rel="stylesheet" href="/static/css/syntax.css" type="text/css" />
    <!-- use to display line number-->
    <!--<link rel="stylesheet" href="/static/css/line.css" type="text/css" />-->
    <!--[if lt IE 9]>
    <script src="/static/js/html5.js" type="text/javascript"></script>
    <![endif]-->
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="home blog lotus index">
    <nav class="lotus-nav">
        <ul>
             
                 
                 
                 
                
            <li class="home ">
                <a href="/" rel="bookmark" title="首页">
                    <i class="icon-home"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="/archives/" rel="bookmark" title="文章归档">
                    <i class="icon-reorder"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="https://github.com/jacoffee/jacoffee.github.io" rel="bookmark" title="博客源代码">
                    <i class="icon-github"></i>
                </a>
                
            </li>
            
        </ul>
    </nav>

    <p class="lotus-breadcrub">
    <a href="/" rel="nofollow" rel="nofollow" title="首页">Home</a>
    <span> &gt; </span>
    <a href="/archives/" rel="nofollow" >Archives</a>
    <span> &gt; </span>
    Scala基础之懒加载变量
</p>

<h1 class="lotus-pagetit">Scala基础之懒加载变量</h1>

<p class="lotus-meta">Published on <time class="date" pubdate="2016-03-04">2016-03-04</time></p>

<article  itemscope itemtype="http://schema.org/Article" class="lotus-post">
<p>在Scala中lazy关键字还是使用的比较多的, lazy变量是在调用的时候初始化一次的。 当多个线程同时访问该变量的时候，这就不可避免的要涉及到<strong>变量共享</strong>， 我们需要确保当该变量在一个线程中初始化之后，另一个线程访问的时候不再初始化。那么Scala到底是如何实现lazy变量的？</p>

<p>下面是一个基本的测试用例:</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">LazyVar</span> <span class="o">{</span>
    <span class="k">lazy</span> <span class="k">val</span> <span class="n">bar</span> <span class="k">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
    <span class="k">lazy</span> <span class="k">val</span> <span class="n">foo</span> <span class="k">=</span> <span class="s">"allen"</span>
<span class="o">}</span>
</code></pre></div>
<p>反编译的代码:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LazyVar</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">bar</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">foo</span><span class="o">;</span>
    <span class="c1">// byte的默认值0</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">byte</span> <span class="n">bitmap</span><span class="err">$</span><span class="mi">0</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">double</span> <span class="n">bar$lzycompute</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bitmap</span><span class="err">$</span><span class="mi">0</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">bar</span> <span class="o">=</span> <span class="kn">package</span><span class="o">..</span><span class="na">MODULE</span><span class="err">$</span><span class="o">.</span><span class="na">pow</span><span class="o">(</span><span class="mf">5.0</span><span class="n">D</span><span class="o">,</span> <span class="mf">3.0</span><span class="n">D</span><span class="o">);</span>
                <span class="k">this</span><span class="o">.</span><span class="na">bitmap</span><span class="err">$</span><span class="mi">0</span> <span class="o">=</span> <span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bitmap</span><span class="err">$</span><span class="mi">0</span> <span class="o">|</span> <span class="mh">0x1</span><span class="o">));</span>
            <span class="o">}</span> 
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">bar</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">foo$lzycompute</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bitmap</span><span class="err">$</span><span class="mi">0</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> 
                <span class="k">this</span><span class="o">.</span><span class="na">foo</span> <span class="o">=</span> <span class="s">"allen"</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">bitmap</span><span class="err">$</span><span class="mi">0</span> <span class="o">=</span> <span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bitmap</span><span class="err">$</span><span class="mi">0</span> <span class="o">|</span> <span class="mh">0x2</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">foo</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">double</span> <span class="n">bar</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bitmap</span><span class="err">$</span><span class="mi">0</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">bar$lzycompute</span><span class="o">()</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">bar</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="n">foo</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bitmap</span><span class="err">$</span><span class="mi">0</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">foo$lzycompute</span><span class="o">()</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">foo</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>
<p>关于上面代码实现的几点解释:</p>

<p><1> <strong>双重检验锁</strong></p>

<blockquote>
<p>In Scala, it use double-checked lock -- when in the synchronized block, it will check again whether the variable been protected has been initialized.</p>
</blockquote>

<p>在调用foo方法的时候，检验bar是否被初始化；如果没有，通过synchronized获取锁。但可能在获取锁的瞬间在另一个线程访问的时候被初始化了，所以还要对标识变量再次检验以确保不会重复初始化。</p>

<p><2> <strong>lazy变量的个数与bitmap的实现策略</strong></p>

<p>当lazy变量只有1个，直接用布尔值来判断;当lazy变量的个数小于等于8个，可以通过bitmap的对应位数上是1还是0来判断;
当lazy变量的个数超过8个的时候，一个字节的8个位便不足以再进行判断，需要将bitmap扩展为整形格式，判断也会更复杂，这里不再赘述。</p>

<p><3> <strong>判断lazy变量是否已经初始化的标识</strong></p>

<p>按位与 (&amp;) -- 相同位的两个数，<strong>如果都为1，则结果为1；其它情况均为0</strong>; 按位或 (|) -- 相同位的两个数，<strong>如果其中一个为1，则结果为1；其它情况均为0</strong>。</p>

<p>对于bar变量的初始化判断标准就是: 如果bitmap的末位为0，则说明该变量没有被初始化;和0x1的按位与只有在末位为1的时候才会返回1。
<strong>(this.bitmap$0 &amp; 0x1) == 0</strong>说明bitmap末位是0，所以进行初始化，然后将bitmap的末位赋值为<strong>(this.bitmap$0 | 0x1)</strong>通过按位与将末位变成1。 </p>

<h2>参考</h2>

<p><1> <a href="https://en.wikipedia.org/wiki/Double-checked_locking#Usage_in_Java">Double-checked lock</a></p>

</article>


<p class="lotus-anno">声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="nofollow" target="_blank" title="自由转载-非商用-非衍生-保持署名">BY-NC-SA</a> 授权。转载请注明转自: 
<a href="/scala/lazy-variable/" rel="nofollow">Allen</a></p>

<section class="lotus-nextpage fn-clear">
    
    <div class="lotus-nextpage-left"><a class="prev" href="/mongodb/bson-date/" rel="prev">&laquo;&nbsp;MongoDB基础之BSON Date</a></div>
    
    
    <div class="lotus-nextpage-right"><a class="next" href="/scala/path-dependent-type/" rel="next">Scala基础之路径依赖类型以及类型投影&nbsp;&raquo;</a></div>
    
</section>


<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="cbf39c821f9351c5ac7d70065c9d793d" data-title="Scala基础之懒加载变量" data-url="/scala/lazy-variable/"></div>
<!-- 多说评论框 end -->



    <footer class="lotus-footer">
        <p>©2016 allen with website template from <a href="https://github.com/pizn/iLotus" target="_blank">iLotus</a> </p>
    </footer>
    <script src="/static/js/jquery.js" type="text/javascript"></script>
    <script src="/static/js/jquery.scrollTo.js" type="text/javascript"></script>
    <script src="/static/js/iLotus.js" type="text/javascript"></script>
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
        var duoshuoQuery = {
            short_name: "roadtopro"
        };
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';
            ds.async = true;
            ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共JS代码 end -->
</body>

</html>