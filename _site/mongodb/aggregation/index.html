<!DOCTYPE html>
<html id="J-html" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="generator" content="Jekyll" />
    <title>MongoDB基础之聚合(aggregation)</title>
    <meta name="description" content="本文简单地介绍了MongoDB的聚合的相关使用" />
    <meta name="keywords" content="聚合，aggregation，管道，pipeline,降维" /><!-- For SEO-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" type="text/css" media="all" href="/static/css/style.css" />
    <!-- syntax highlighting CSS  need pygments support-->
    <link rel="stylesheet" href="/static/css/syntax.css" type="text/css" />
    <!-- use to display line number-->
    <!--<link rel="stylesheet" href="/static/css/line.css" type="text/css" />-->
    <!--[if lt IE 9]>
    <script src="/static/js/html5.js" type="text/javascript"></script>
    <![endif]-->
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="home blog lotus index">
    <nav class="lotus-nav">
        <ul>
             
                 
                 
                 
                
            <li class="home ">
                <a href="/" rel="bookmark" title="首页">
                    <i class="icon-home"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="/archives/" rel="bookmark" title="文章归档">
                    <i class="icon-reorder"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="https://github.com/jacoffee/jacoffee.github.io" rel="bookmark" title="博客源代码">
                    <i class="icon-github"></i>
                </a>
                
            </li>
            
        </ul>
    </nav>

    <p class="lotus-breadcrub">
    <a href="/" rel="nofollow" rel="nofollow" title="首页">Home</a>
    <span> &gt; </span>
    <a href="/archives/" rel="nofollow" >Archives</a>
    <span> &gt; </span>
    MongoDB基础之聚合(aggregation)
</p>

<h1 class="lotus-pagetit">MongoDB基础之聚合(aggregation)</h1>

<p class="lotus-meta">Published on <time class="date" pubdate="2015-05-20">2015-05-20</time></p>

<article  itemscope itemtype="http://schema.org/Article" class="lotus-post">
<p>MongoDB中聚合可以分为很多种，目前我接触的比较多就是pipeline, 它实际上就是将一堆collection扔进去然后按照特定条件分组并且提供一定的筛选条件，最后获取你想要的结果。</p>

<h1>问题</h1>

<p>在MongoDB中，如何使用pipeline?</p>

<h1>解决</h1>

<p>pipeline顾名思义就是管道，以大量的documents作为输入，每一阶段都会对文档进行处理，直到产生最终的结果，当然在此过程也可能产生新的文档。在MongoDB中，pipeline的基本语法如下:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">collection.aggregate
</code></pre></div>
<h2>常见的Stage</h2>

<p>几个在MongoDB基本查询中也会经常用到的$limit, $sort, $skip,
两个在Aggregation中经常使用的$match, $group。第一个实际上就是普通查询的查询条件，第二个类似于MySQL中的分组。
还有几个个人接触的比较少但是觉得比较有意思的$unwind, $redact。</p>

<p>本文重点介绍一下$group, 其次是$unwind。</p>

<p><1> $group</p>

<p>该操作针对传入的Documents进行分组，然后将分好组的Documents传递给下一个阶段。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">{</span>
    <span class="nv">$group</span>: <span class="o">{</span> 
        _id: &lt;expression&gt;, &lt;field1&gt;: <span class="o">{</span> &lt;accumulator1&gt; : &lt;expression1&gt; <span class="o">}</span>, ...     <span class="o">}</span> 
<span class="o">}</span>
</code></pre></div>
<p>引入测试数据</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">db.sales.insert<span class="o">(</span>
<span class="o">[</span>
  <span class="o">{</span> 
    <span class="s2">"_id"</span> : 1, <span class="s2">"item"</span> : <span class="s2">"abc"</span>, <span class="s2">"price"</span> : 10, 
    <span class="s2">"quantity"</span> : 2, <span class="s2">"date"</span> : ISODate<span class="o">(</span><span class="s2">"2014-01-01T08:00:00Z"</span><span class="o">)</span> 
  <span class="o">}</span>,
  <span class="o">{</span> 
    <span class="s2">"_id"</span> : 2, <span class="s2">"item"</span> : <span class="s2">"jkl"</span>, <span class="s2">"price"</span> : 20, 
    <span class="s2">"quantity"</span> : 1, <span class="s2">"date"</span> : ISODate<span class="o">(</span><span class="s2">"2014-02-03T09:00:00Z"</span><span class="o">)</span> 
  <span class="o">}</span>,
  <span class="o">{</span> 
    <span class="s2">"_id"</span> : 3, <span class="s2">"item"</span> : <span class="s2">"xyz"</span>, <span class="s2">"price"</span> : 5, 
    <span class="s2">"quantity"</span> : 5, <span class="s2">"date"</span> : ISODate<span class="o">(</span><span class="s2">"2014-02-03T09:05:00Z"</span><span class="o">)</span> 
  <span class="o">}</span>,
  <span class="o">{</span> 
    <span class="s2">"_id"</span> : 4, <span class="s2">"item"</span> : <span class="s2">"abc"</span>, <span class="s2">"price"</span> : 10, 
    <span class="s2">"quantity"</span> : 10, <span class="s2">"date"</span> : ISODate<span class="o">(</span><span class="s2">"2014-02-15T08:00:00Z"</span><span class="o">)</span> 
  <span class="o">}</span>,
  <span class="o">{</span> 
    <span class="s2">"_id"</span> : 5, <span class="s2">"item"</span> : <span class="s2">"xyz"</span>, <span class="s2">"price"</span> : 5, 
    <span class="s2">"quantity"</span> : 10, <span class="s2">"date"</span> : ISODate<span class="o">(</span><span class="s2">"2014-02-15T09:05:00Z"</span><span class="o">)</span> 
  <span class="o">}</span>,
  <span class="o">{</span> 
    <span class="s2">"_id"</span> : 6, <span class="s2">"item"</span> : <span class="s2">"xyz"</span>, <span class="s2">"price"</span> : 5, 
    <span class="s2">"quantity"</span> : 5, <span class="s2">"date"</span> : ISODate<span class="o">(</span><span class="s2">"2014-02-15T12:05:10Z"</span><span class="o">)</span> 
  <span class="o">}</span>,
  <span class="o">{</span> 
    <span class="s2">"_id"</span> : 7, <span class="s2">"item"</span> : <span class="s2">"xyz"</span>, <span class="s2">"price"</span> : 5, 
    <span class="s2">"quantity"</span> : 10, <span class="s2">"date"</span> : ISODate<span class="o">(</span><span class="s2">"2014-02-15T14:12:12Z"</span><span class="o">)</span> 
  <span class="o">}</span>
<span class="o">])</span>
</code></pre></div>
<p><1> _id属性是必须的，但是也可以设置成null这样来计算所有文档的某个值。
<2> 第二个属性传入的必须是使用accumulator统计的值</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="s2">"</span><span class="nv">$group</span><span class="s2">"</span>: <span class="o">{</span> <span class="s2">"_id"</span>: <span class="s2">"</span><span class="nv">$_id</span><span class="s2">"</span>, item: <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span> <span class="o">}</span> // 错误

<span class="s2">"</span><span class="nv">$group</span><span class="s2">"</span>: <span class="o">{</span> <span class="s2">"_id"</span>: <span class="s2">"</span><span class="nv">$_id</span><span class="s2">"</span>, total: <span class="o">{</span><span class="s2">"</span><span class="nv">$sum</span><span class="s2">"</span>: <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span><span class="o">}</span> <span class="o">}</span> // 正确 

<span class="s2">"</span><span class="nv">$group</span><span class="s2">"</span>: <span class="o">{</span> <span class="s2">"_id"</span>: <span class="o">{</span> identity: <span class="s2">"</span><span class="nv">$_id</span><span class="s2">"</span>, item: <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span> <span class="o">}}</span> 
// 正确 有点类似于联合主键的意思
</code></pre></div>
<p>其它的包括:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$sum</span>: 统计分组中某个字段的和
<span class="nv">$avg</span>: 统计分组中某个字段的平均值
<span class="nv">$first</span> | <span class="nv">$last</span>: 返回分组中的第一个或最后一个文档中的某个值
<span class="nv">$max</span> | <span class="nv">$min</span>: 相对于<span class="nv">$first</span> | <span class="nv">$last</span>实际上有一个潜在的排序过程，因为要寻找的是最小和最大值
<span class="nv">$push</span>: 把每组指定属性值放到一个集合中
<span class="nv">$addToSet</span>: 相较于<span class="nv">$push</span>来说强调唯一性，但是不保证顺序
</code></pre></div>
<p>下面使用案例来验证上面的accumulator。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">db.sales.aggregate<span class="o">([</span>
    <span class="o">{</span><span class="s2">"</span><span class="nv">$sort</span><span class="s2">"</span>: <span class="o">{</span><span class="s2">"quantity"</span>: 1<span class="o">}}</span>,
    <span class="o">{</span>
        <span class="s2">"</span><span class="nv">$group</span><span class="s2">"</span>: 
       <span class="o">{</span>
           <span class="s2">"_id"</span>: <span class="s2">"</span><span class="nv">$item</span><span class="s2">"</span>,
           <span class="s2">"firstDate"</span>: <span class="o">{</span><span class="s2">"</span><span class="nv">$first</span><span class="s2">"</span>: <span class="s2">"</span><span class="nv">$date</span><span class="s2">"</span><span class="o">}</span>,
           <span class="s2">"lastDate"</span>: <span class="o">{</span><span class="s2">"</span><span class="nv">$last</span><span class="s2">"</span>: <span class="s2">"</span><span class="nv">$date</span><span class="s2">"</span><span class="o">}</span>,
           <span class="s2">"maxQ"</span>: <span class="o">{</span><span class="s2">"</span><span class="nv">$max</span><span class="s2">"</span>: <span class="s2">"</span><span class="nv">$date</span><span class="s2">"</span><span class="o">}</span>,
           <span class="s2">"minQ"</span>: <span class="o">{</span><span class="s2">"</span><span class="nv">$min</span><span class="s2">"</span>: <span class="s2">"</span><span class="nv">$date</span><span class="s2">"</span><span class="o">}</span>,
           <span class="s2">"q1"</span>: <span class="o">{</span> <span class="nv">$push</span>: <span class="s2">"</span><span class="nv">$quantity</span><span class="s2">"</span><span class="o">}</span>, 
           <span class="s2">"q2"</span>: <span class="o">{</span> <span class="nv">$addToSet</span>: <span class="s2">"</span><span class="nv">$quantity</span><span class="s2">"</span><span class="o">}</span>,
           <span class="s2">"qAvg"</span>: <span class="o">{</span><span class="nv">$avg</span>: <span class="s2">"</span><span class="nv">$quantity</span><span class="s2">"</span><span class="o">}</span>,
           <span class="s2">"qSum"</span>: <span class="o">{</span><span class="nv">$sum</span>: <span class="s2">"</span><span class="nv">$quantity</span><span class="s2">"</span><span class="o">}</span>
       <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span><span class="s2">"</span><span class="nv">$limit</span><span class="s2">"</span>: 1<span class="o">}</span>
<span class="o">])</span>
</code></pre></div><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="s2">"result"</span> : <span class="o">[</span> 
    <span class="o">{</span>
        <span class="s2">"_id"</span> : <span class="s2">"xyz"</span>,
        <span class="s2">"firstDate"</span> : 10,
        <span class="s2">"lastDate"</span> : ISODate<span class="o">(</span><span class="s2">"2014-02-15T14:12:12.000Z"</span><span class="o">)</span>,
        <span class="s2">"maxQ"</span> : ISODate<span class="o">(</span><span class="s2">"2014-02-23T09:05:00.000Z"</span><span class="o">)</span>,
        <span class="s2">"minQ"</span> : ISODate<span class="o">(</span><span class="s2">"2014-02-03T09:05:00.000Z"</span><span class="o">)</span>,
        <span class="s2">"q1"</span> : <span class="o">[</span> 
            3, 
            5, 
            5, 
            10, 
            10
        <span class="o">]</span>,
        <span class="s2">"q2"</span> : <span class="o">[</span> 
            10, 
            5, 
            3
        <span class="o">]</span>,
        <span class="s2">"qAvg"</span> : 6.6,
        <span class="s2">"qSum"</span> : 33
    <span class="o">}</span>
<span class="o">]</span>,
<span class="s2">"ok"</span> : 1
<span class="o">}</span>
</code></pre></div>
<p><2> $unwind</p>

<p>这个modifier可以理解为是在降维， 如果对q2使用unwind操作，则原对象会被拆成三个对象，每一个对象的q2分别是10, 5, 3。这个操作即使针对重复值也会被当做单独的值处理。</p>

<h2>Pipeline中的性能优化</h2>

<ul>
<li><p>当$sort和$match在一起的时候，不论顺序是怎样的，$match都会被移到$sort之前，这样通过$match可以大大减小需要排序的documents。</p></li>
<li><p>当$skip和$limit在一起的时候，不论顺序是怎样的，$limit都会被放$skip前面，减少$skip的数量。因为skip需要MongoDB Server去从头开始扫描文档，直到停止的位置，然后将数据加载到内存中。所以当skip的数目比较大的时候，性能损耗就会比较大。</p></li>
<li><p>当$limit和$limit在一起的时候，最终的结果是limit值更小的那个。</p></li>
<li><p>当$skip和$skip在一起的时候，最终的结果是两个的skip值相加。</p></li>
<li><p>当$match和$match在一起的时候，最终的结果就是两个查询条件的并集。</p></li>
</ul>

<h2>参考</h2>

<p><1> <a href="https://docs.mongodb.org/manual/aggregation/">MongoDB Aggregation and Data Processing</a></p>

<p><2> <a href="http://stackoverflow.com/questions/7228169/slow-pagination-over-tons-of-records-in-mongo#">Paging</a></p>

<p><3> <a href="http://media.mongodb.org/zips.json">Sample Code</a></p>

<p><4> <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/first/#grp._S_first">Aggregation Modifier First</a></p>

</article>


<p class="lotus-anno">声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="nofollow" target="_blank" title="自由转载-非商用-非衍生-保持署名">BY-NC-SA</a> 授权。转载请注明转自: 
<a href="/mongodb/aggregation/" rel="nofollow">Allen</a></p>

<section class="lotus-nextpage fn-clear">
    
    <div class="lotus-nextpage-left"><a class="prev" href="/linux/kill-processes/" rel="prev">&laquo;&nbsp;Linux基础之杀死进程(kill processes)</a></div>
    
    
    <div class="lotus-nextpage-right"><a class="next" href="/spray/directive/" rel="next">Spray基础之Directive(路由)&nbsp;&raquo;</a></div>
    
</section>


<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="7b60b33c122bd6b3f2462615e6424199" data-title="MongoDB基础之聚合(aggregation)" data-url="/mongodb/aggregation/"></div>
<!-- 多说评论框 end -->



    <footer class="lotus-footer">
        <p>©2016 allen with website template from <a href="https://github.com/pizn/iLotus" target="_blank">iLotus</a> </p>
    </footer>
    <script src="/static/js/jquery.js" type="text/javascript"></script>
    <script src="/static/js/jquery.scrollTo.js" type="text/javascript"></script>
    <script src="/static/js/iLotus.js" type="text/javascript"></script>
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
        var duoshuoQuery = {
            short_name: "roadtopro"
        };
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';
            ds.async = true;
            ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共JS代码 end -->
</body>

</html>