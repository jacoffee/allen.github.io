<!DOCTYPE html>
<html id="J-html" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="generator" content="Jekyll" />
    <title>MongoDB基础之BSON Date</title>
    <meta name="description" content="本文简单地介绍了MongoDB的日期类型以及在文档中的表示" />
    <meta name="keywords" content="BSON Date，UTC，ISO 8601，Decimal fraction of second" /><!-- For SEO-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" type="text/css" media="all" href="/static/css/style.css" />
    <!-- syntax highlighting CSS  need pygments support-->
    <link rel="stylesheet" href="/static/css/syntax.css" type="text/css" />
    <!-- use to display line number-->
    <!--<link rel="stylesheet" href="/static/css/line.css" type="text/css" />-->
    <!--[if lt IE 9]>
    <script src="/static/js/html5.js" type="text/javascript"></script>
    <![endif]-->
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="home blog lotus index">
    <nav class="lotus-nav">
        <ul>
             
                 
                 
                 
                
            <li class="home ">
                <a href="/" rel="bookmark" title="首页">
                    <i class="icon-home"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="/archives/" rel="bookmark" title="文章归档">
                    <i class="icon-reorder"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="https://github.com/jacoffee/jacoffee.github.io" rel="bookmark" title="博客源代码">
                    <i class="icon-github"></i>
                </a>
                
            </li>
            
        </ul>
    </nav>

    <p class="lotus-breadcrub">
    <a href="/" rel="nofollow" rel="nofollow" title="首页">Home</a>
    <span> &gt; </span>
    <a href="/archives/" rel="nofollow" >Archives</a>
    <span> &gt; </span>
    MongoDB基础之BSON Date
</p>

<h1 class="lotus-pagetit">MongoDB基础之BSON Date</h1>

<p class="lotus-meta">Published on <time class="date" pubdate="2016-01-27">2016-01-27</time></p>

<article  itemscope itemtype="http://schema.org/Article" class="lotus-post">
<p>接触MongoDB到现在已经有两年了，但对于日期类型还是很模糊的，印象中就只有ISODate， 因为几乎所有文档的日期类型都是用它表示的<code>ISODate(&quot;2014-04-16T03:39:14.874Z&quot;)</code>。 理解也仅限于，它好像和JS中的Date有点类似。所以决定系统的研究一下。</p>

<p>(1) Mongodb中日期类型使用BSON Date表示，而BSON Date对象是以64bit的integer来存储的(实际上就是Java，Scala的Long， 表示范围-2 ^ 63 to 2 ^ 63 - 1)，表示从Unix Epoch(1970-01-01)到某个时间点的<strong>毫秒数</strong>，大概可以表示从那个时间点往前或往后的2.9亿年。</p>

<p>计算过程如下:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">scala&gt; </span>val ll: Long <span class="o">=</span> pow<span class="o">(</span>2, 63<span class="o">)</span>.toLong
ll: Long <span class="o">=</span> 9223372036854775807

<span class="gp">scala&gt; </span>ll - 1
res3: Long <span class="o">=</span> 9223372036854775806

<span class="gp">scala&gt; </span>res3 / 1000 / 3600 / 24 / 365
res4: Long <span class="o">=</span> 292471208
</code></pre></div>
<p><a href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a>(国际日期和时间规范)对于时间定义了如下几个<a href="https://www.w3.org/TR/NOTE-datetime">级别</a>:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"> YYYY <span class="o">=</span> 四位数表示的年 如 2016
 MM   <span class="o">=</span> 两位数表示的月 如 01
 DD   <span class="o">=</span> 两位数表示的日 如 27
 hh   <span class="o">=</span> 两位数表示的小时 <span class="o">(</span>00 through 23<span class="o">)</span> 如09
 mm   <span class="o">=</span> 两位数表示的分 <span class="o">(</span>00 through 59<span class="o">)</span> 如51
 ss   <span class="o">=</span> 两位数表示的秒 <span class="o">(</span>00 through 59<span class="o">)</span> 如02
 s    <span class="o">=</span> 一位或多位来表示秒的小数<span class="o">(</span>decimal fraction<span class="o">)</span>部分，基于精度的考虑 如051<span class="o">(</span>下文有解释<span class="o">)</span>
 TZD  <span class="o">=</span> 时区表示 <span class="o">(</span>Z or +hh:mm or -hh:mm<span class="o">)</span>
</code></pre></div>
<p>另外当要表示时区差异时，也提供了如下两种方式:</p>

<blockquote>
<ol>
<li>Times are expressed in UTC (Coordinated Universal Time), with a special UTC designator (&quot;Z&quot;).</li>
<li>Times are expressed in local time, together with a time zone offset in hours and minutes. A time zone offset of &quot;+hh:mm&quot; indicates that the date/time uses a local time zone which is &quot;hh&quot; hours and &quot;mm&quot; minutes ahead of UTC. A time zone offset of &quot;-hh:mm&quot; indicates that the date/time uses a local time zone which is &quot;hh&quot; hours and &quot;mm&quot; minutes behind UTC.</li>
</ol>
</blockquote>

<p>如果以UTC表示的话，就会在最后直接加上一个Z;</p>

<p>如果以当地时间表示的话就需要指定时差(基于UTC)，以上海为例就应该是+08:00, 表示上海时间比UTC时间快8个小时。</p>

<p>而<a href="http://bsonspec.org/#/specification">BSON官方文档</a>对于BSON Date的定义也是UTC datetime, 所以MongoDB的日期是以UTC datetime存储的，如下:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">{</span>
    ...
    <span class="s2">"created_at"</span> : ISODate<span class="o">(</span><span class="s2">"2016-01-27T09:51:02.051Z"</span><span class="o">)</span>,
    ...
<span class="o">}</span>
</code></pre></div>
<p>前面我们提到过BSON Date是从Unix Epoch以来的毫秒数，MongoDB Date中的<strong>s</strong>使用的是三位，即上面的051，也就是毫秒数，通过如下命令可以得到:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># mongodb js console</span>
<span class="gp">18&gt; </span>current
ISODate<span class="o">(</span><span class="s2">"2016-01-27T09:59:53.602Z"</span><span class="o">)</span>
<span class="gp">19&gt; </span>current.getMilliseconds<span class="o">()</span>
602
</code></pre></div>
<p>(2) MongoDB还有一种<strong>供内部使用</strong>的时间类型叫Timestamps，比如说<strong>oplog</strong>中有一个<strong>ts</strong>属性，就是使用该类型。一般我们开发的时候并不会使用这个类型。</p>

<p>最后，就是各种语言的MongoDB Drive在转换ISODate时可能会有不同的策略，所以要根据具体的实现来进行相应的操作。</p>

<h2>参考</h2>

<p><1> <a href="https://www.w3.org/TR/NOTE-datetime">W3C对于datetime的规范</a></p>

<p><2> <a href="https://docs.mongodb.org/manual/reference/bson-types/#timestamps">MongoDB 时间类型概述</a></p>

<p><3> <a href="https://docs.mongodb.org/manual/core/shell-types/">MongoDB 时间类型的构造方法</a></p>

<p><4> <a href="https://en.wikipedia.org/wiki/Decimal_time#China">Decimal Time关于秒小数部分的解释</a></p>

</article>


<p class="lotus-anno">声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="nofollow" target="_blank" title="自由转载-非商用-非衍生-保持署名">BY-NC-SA</a> 授权。转载请注明转自: 
<a href="/mongodb/bson-date/" rel="nofollow">Allen</a></p>

<section class="lotus-nextpage fn-clear">
    
    <div class="lotus-nextpage-left"><a class="prev" href="/http/cross-origin/" rel="prev">&laquo;&nbsp;从前到后看跨域访问</a></div>
    
    
    <div class="lotus-nextpage-right"><a class="next" href="/scala/lazy-variable/" rel="next">Scala基础之懒加载变量&nbsp;&raquo;</a></div>
    
</section>


<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="cf1bc6b91fd0a95fece8eb7beaeaa341" data-title="MongoDB基础之BSON Date" data-url="/mongodb/bson-date/"></div>
<!-- 多说评论框 end -->



    <footer class="lotus-footer">
        <p>©2016 allen with website template from <a href="https://github.com/pizn/iLotus" target="_blank">iLotus</a> </p>
    </footer>
    <script src="/static/js/jquery.js" type="text/javascript"></script>
    <script src="/static/js/jquery.scrollTo.js" type="text/javascript"></script>
    <script src="/static/js/iLotus.js" type="text/javascript"></script>
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
        var duoshuoQuery = {
            short_name: "roadtopro"
        };
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';
            ds.async = true;
            ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共JS代码 end -->
</body>

</html>