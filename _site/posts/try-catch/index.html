<!DOCTYPE html>
<html id="J-html" class="">
<head>
    <meta charset="UTF-8" />
    <title>
         
            Allen写字的地方 | Scala基础之try...catch...finally 
        
    </title>
    <meta name="generator" content="Jekyll" />
    <meta name="author" content="" />
    <meta name="description" content="Allen写字的地方 | " />
    <meta name="description" content="编程不仅仅是代码的积累，也是思考深度和广度的积累，写博客是一种不错的途径" />
    <meta name="keywords" content="" /><!-- For SEO-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" media="all" href="http://roadtopro.me/static/css/style.css" />
    <!-- syntax highlighting CSS  need pygments support-->
    <link rel="stylesheet" href="/static/css/syntax.css" type="text/css" />
    <!-- use to display line number-->
    <!--<link rel="stylesheet" href="/static/css/line.css" type="text/css" />-->
    <!--[if lt IE 9]>
    <script src="http://roadtopro.me/static/js/html5.js" type="text/javascript"></script>
    <![endif]-->
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="home blog lotus index">
    <nav class="lotus-nav">
        <ul>
             
                 
                 
                 
                 
                     
                
            <li class="home ">
                <a href="/" rel="bookmark" title="首页">
                    <i class="icon-home"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="/archives/" rel="bookmark" title="文章归档">
                    <i class="icon-reorder"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="/contact/" rel="bookmark" title="关于我">
                    <i class="icon-envelope-alt"></i>
                </a>
                
            </li>
             
                 
                 
                 
                
            <li class="">
                <a href="https://github.com/jacoffee/jacoffee.github.io" rel="bookmark" title="博客源代码">
                    <i class="icon-github"></i>
                </a>
                
            </li>
            
        </ul>
    </nav>

    <p class="lotus-breadcrub">
    <a href="http://roadtopro.me/" rel="nofollow" rel="nofollow" title="首页">Home</a>
    <span> &gt; </span>
    <a href="http://roadtopro.me/archives/" rel="nofollow" >Archives</a>
    <span> &gt; </span>
    Scala基础之try...catch...finally
</p>
<h1 class="lotus-pagetit">Scala基础之try...catch...finally</h1>
<p class="lotus-meta">Published on <time class="date" pubdate="February  4, 2015">February  4, 2015</time></p>
<article  itemscope itemtype="http://schema.org/Article" class="lotus-post">
<h1>问题</h1>

<p>今天，一同事在写一个异常捕获的时候，突然抛出以下代码，让我们研究返回值。</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">getResult</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="k">try</span> <span class="o">{</span>
    <span class="n">println</span><span class="o">(</span><span class="s">&quot;try执行了吗？&quot;</span><span class="err">）</span>
    <span class="k">return</span> <span class="mi">1</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">println</span><span class="o">(</span><span class="s">&quot;finally执行了吗？&quot;</span><span class="err">）</span>
    <span class="k">return</span> <span class="mi">3</span>
<span class="o">}</span>
</code></pre></div>
<p>首先上面那种写法就很奇怪，因为不管是在Scala还是Java中finally一般都是没有返回值的，如果显示声明了return, 那么返回值应该是多少了。答案是此时返回值应该是<b style="color:red">finally中return的值</b>。
如果try中有异常而finally中没有异常且显示的声明了return，此时整个流程怎么走？
如果finally有异常，整个流程又怎么走？
本文会对Scala中detry...catch...finally的整个语法进行梳理，如有不对的地方还请大家指出。</p>

<h1>解决</h1>

<p>首先为什么上面的表达式返回的是3，都说源码面前，了无秘密。通过<a href="http://jd.benow.ca/">Java Decompiler</a>将上面的Scala代码对应的class文件反解，就可以看到如下代码:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">int</span> <span class="nf">getResult</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span> <span class="n">Predef</span><span class="o">..</span><span class="na">MODULE$</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;try 执行了吗？ &quot;</span><span class="o">);</span>

      <span class="k">return</span> <span class="mi">3</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">finally</span>
    <span class="o">{</span>
      <span class="n">Predef</span><span class="o">..</span><span class="na">MODULE$</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot; finally 执行了吗&quot;</span><span class="o">);</span>
    <span class="o">}</span><span class="k">return</span> <span class="mi">3</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div>
<p>显然，finally中的代码已经改变原来的方法的执行流程，可以简单的理解为在Scala中
对于try { b } catch e1 finally e2
<b style="color:red">b的类型是try表达式的期望类型, e1实际上是一个偏函数: scala.PartialFunction[scala.Throwable, pt], pt &lt;: b, 而e2的类型则是Unit</b>。
所以此时的控制流程又回到了try表达式中，因为此时<b style="color:red">只有try{}才可以返回满足方法签名类型的返回值</b>,也就是Int。
同时会将finally中的&#39;返回值&#39;作为最终的值返回。</p>

<p>下面针对不同情况下，try...catch...finally的处理进行解释:</p>

<p><1> 计算b的过程中没有异常</p>

<p>如果在计算表达式e的过程中又抛出异常，那么整个表达式会中止，并且抛出异常(e表达式中包含的异常)</p>

<p>如果在计算表达式的e的过程中没有抛出异常，那么b就是整个表达式的返回值</p>

<p><2> 计算b的过程中有异常(e中的表达式仍然会被计算)</p>

<p>如果e的计算过程也抛出异常，那么表达式会中止并且e过程中的异常被抛出</p>

<p>如果e的计算过程中没有抛出异常，那么原来b中的异常会再e计算完成之后再次抛出</p>

<h1>结语</h1>

<p>我们最开始学习Java时候，各种教材都会讲到在定义Java变量名我们尽量不要采用生僻的命名，这条规则同样适用于这里。我们尽量不要使用各种语法比较妖孽的地方，就比如说finally本来就不该出现return，它通常会用于处理异常抛出之后的收尾工作，比如说关闭流等。</p>

</article>

<p class="lotus-anno">声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="nofollow" target="_blank" title="自由转载-非商用-非衍生-保持署名">BY-NC-SA</a> 授权。转载请注明转自: <a href="" title="" rel="nofollow"></a></p>
<section class="lotus-nextpage fn-clear">
    
    <div class="lotus-nextpage-left"><a class="prev" href="/posts/blog-setup/" rel="prev">&laquo;&nbsp;使用Github Pages + Jekyll搭建个人Blog</a></div>
    
    
</section>


    <footer class="lotus-footer">
        <p>Copyright © 2010–2015 iLotus All rights reserved.</p>
    </footer>
    <script src="http://roadtopro.me/static/js/jquery.js" type="text/javascript"></script>
    <script src="http://roadtopro.me/static/js/jquery.scrollTo.js" type="text/javascript"></script>
    <script src="http://roadtopro.me/static/js/iLotus.js" type="text/javascript"></script>
</body>

</html>